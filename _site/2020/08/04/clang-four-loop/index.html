<!DOCTYPE html>
<html lang="en-us">

  <head>
  <script data-ad-client="ca-pub-9045584981114542" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,"script","//www.google-analytics.com/analytics.js","ga");

    ga("create", "UA-168048864-1", "auto");
    ga("send", "pageview");
  </script>

  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Adding a "Four" loop to Clang Compiler &middot; Andrew Clark's Blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="https://starwarsfan2099.github.io/public/css/poole.css">
  <link rel="stylesheet" href="https://starwarsfan2099.github.io/public/css/syntax.css">
  <link rel="stylesheet" href="https://starwarsfan2099.github.io/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://starwarsfan2099.github.io/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="https://starwarsfan2099.github.io/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A blog for others to follow my adventures and learning experiences in reverse engineering, hardware hacking, and programming.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="https://starwarsfan2099.github.io/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    

    <a class="sidebar-nav-item" href="https://www.twitter.com/starwarsfan2099">Twitter</a>
    <a class="sidebar-nav-item" href="https://www.github.com/Starwarsfan2099">GitHub</a>
    <a class="sidebar-nav-item" href="https://starwarsfan2099.github.io/repo">Cydia Repo</a>
    <span class="sidebar-nav-item">Currently v1.0.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2020. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://starwarsfan2099.github.io/" title="Home">Andrew Clark's Blog</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Adding a "Four" loop to Clang Compiler</h1>
  <span class="post-date">04 Aug 2020</span>
  <p>What if a person was writing a C program and typoed their <code class="highlighter-rouge">for</code> loop. In C, a <code class="highlighter-rouge">for</code> loop is written like <code class="highlighter-rouge">for( int i = 0; i &lt; 12; i++) {...</code>. What if they mistyped and instead wrote <code class="highlighter-rouge">four( int i = 0; i &lt; 12; i++) {...</code>? Well, if using llvm-clang, it will error out and fail to compile, understandable and expected. But that’s no fun. What if instead, it compiled fine and instead of looping over each iteration, it looped every four iterations because it’s a “four” loop?? That would be cool. Lets implement it into clang for fun and learning!</p>

<p>First, we need to download and make sure we can build clang. The llvm project with llvm-clang can be found <a href="https://github.com/llvm/llvm-project">here on Github</a>. First, clone the repository and associated dependencies with git.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/llvm/llvm-project.git
</code></pre></div></div>

<p>Next we need to change directory to the llvm-clang directory and create a build directory. llvm-clang supports several build systems. I’m going to use <code class="highlighter-rouge">cmake</code> to configure the build scripts and then <code class="highlighter-rouge">make</code> to build everything. With <code class="highlighter-rouge">cmake</code>, we are going to pass <code class="highlighter-rouge">-DLLVM_ENABLE_PROJECTS=clang</code> and <code class="highlighter-rouge">-DLLVM_TARGETS_TO_BUILD=X86</code> to enable building clang, and have clang only target x86 to speed up the compilation some. We’ll also pass ``-G “Unix Makefiles”<code class="highlighter-rouge"> so we can use make to build everything. Next run </code>make -j [number of threads]<code class="highlighter-rouge">. The </code>-j<code class="highlighter-rouge"> tells </code>make<code class="highlighter-rouge"> how many threads to use. llvm-clang takes fairly long to compile so we definitely want to use more than one thread. I'm using an 8 core MacBook Pro, so I used </code>make -j 8`. Then patiently wait for clang to build.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd llvm-project
mkdir build
cd build
cmake -DLLVM_ENABLE_PROJECTS=clang -DLLVM_TARGETS_TO_BUILD=X86 -G "Unix Makefiles" ../llvm
make -j 8
</code></pre></div></div>

<p>If clang builds successfully, you can find the binary in <code class="highlighter-rouge">build/bin</code>. Now, we need to add our “four” loop. Opening the clang source code in Visual Studio is very overwhelming. There is <strong>a lot</strong> of source code. After building llvm, there are 109880 files within the <code class="highlighter-rouge">llvm-project</code> directory. Where do we start looking for the code associated with <code class="highlighter-rouge">for</code> loops? We are interested in modifying clang, so a good first place to start is <code class="highlighter-rouge">llvm-project/clang</code>. There are still a large amount of files here to though. We need a plan of action. Let’s see if we can modify the current <code class="highlighter-rouge">for</code> loop to only loop every four iterations. Delving into the source files in clang, we find <code class="highlighter-rouge">clang/lib/CodeGen/</code>. That looks promising since we want to modify the code generated for the <code class="highlighter-rouge">for</code> loop. The files are named like <code class="highlighter-rouge">CGObjCRuntime.cpp</code> and <code class="highlighter-rouge">CGLoopInfo.cpp</code>. There doesn’t seem to be anything to use of us in <code class="highlighter-rouge">CGLoopInfo.cpp</code>. However, there is an interesting file named <code class="highlighter-rouge">CGStmt.cpp</code>. <code class="highlighter-rouge">for</code> loops are <a href="https://en.wikibooks.org/wiki/C_Programming/Statements">iteration statements</a> so this file could be useful. Searching the rather large file for the keyword “for” results in way to many results. Near the top of the file though, around line 140 are these lines:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>case Stmt::IfStmtClass:      EmitIfStmt(cast&lt;IfStmt&gt;(*S));              break;
case Stmt::WhileStmtClass:   EmitWhileStmt(cast&lt;WhileStmt&gt;(*S), Attrs); break;
case Stmt::DoStmtClass:      EmitDoStmt(cast&lt;DoStmt&gt;(*S), Attrs);       break;
case Stmt::ForStmtClass:     EmitForStmt(cast&lt;ForStmt&gt;(*S), Attrs);     break;
</code></pre></div></div>

<p><code class="highlighter-rouge">EmitForStmt</code> immediately stands out and could be interesting. <code class="highlighter-rouge">CodeGenFunction::EmitForStmt</code> is found on line 882. By “Emit”, clang it is talking about exporting llvm bytecode. Comments reveal this code evaluates the loop and deals with increments. Further down in the function, it looks like we find where the <code class="highlighter-rouge">for</code> loop is incremented!</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// If there is an increment, emit it next.
if (S.getInc()) {
    EmitBlock(Continue.getBlock());
    EmitStmt(S.getInc());
</code></pre></div></div>

<p>To test this, we can copy <code class="highlighter-rouge">EmitStmt(S.getInc());</code> 3 more times in the code block. So it should look like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// If there is an increment, emit it next.
if (S.getInc()) {
    EmitBlock(Continue.getBlock());
    EmitStmt(S.getInc());
    EmitStmt(S.getInc());
    EmitStmt(S.getInc());
    EmitStmt(S.getInc());
</code></pre></div></div>

<p>Now, we need to recompile and test. To recompile, just run <code class="highlighter-rouge">make -j 8</code> again. Then compile a program with a simple for loop and see what happens:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>For Loop
0
4
8
12
</code></pre></div></div>

<p>Success! Kind of. Now the normal <code class="highlighter-rouge">for</code> statement increments by four, but we want the <code class="highlighter-rouge">for</code> loop to be normal and add a <code class="highlighter-rouge">four</code> statement that increments by four. It’s going to be really difficult to add entirely new code to create our <code class="highlighter-rouge">four</code> loop. So, maybe we can modify the <code class="highlighter-rouge">for</code> loop code that is already in place. We can create another function argument that gets passed all the way down to <code class="highlighter-rouge">CodeGenFunction::EmitForStmt</code>. Then we can just add a different token in the lexer that looks for our <code class="highlighter-rouge">four</code> statement in the code and simply calls the <code class="highlighter-rouge">for</code> loop code with the extra argument. What we need first is to find the lexer and tokens clang uses. The compiler lexer looks at the lines of code in the source file and determines what is a statement, string, operator, separator, etc… and a assigns a token to it that describes what it is. Then the tokens are used in later compilation steps. Based upon some quick Googling, tokens for clang are defined in <code class="highlighter-rouge">clang/include/clang/basic/TokenKinds.def</code>. Doing a keyword search for the word “for” takes us to line 296:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KEYWORD(extern                      , KEYALL)
KEYWORD(float                       , KEYALL)
KEYWORD(for                         , KEYALL)
KEYWORD(goto                        , KEYALL)
KEYWORD(if                          , KEYALL)
KEYWORD(inline                      , KEYC99|KEYCXX|KEYGNU)
KEYWORD(int                         , KEYALL)
</code></pre></div></div>

<p>Each statement is given a keyword assignment, so clang knows what terms are statements. The 2nd column are flags for the keyword. The flag <code class="highlighter-rouge">KEYALL</code> means the statement is present in all variants of C or C++. <code class="highlighter-rouge">KEYC99</code> and shown above means the feature was introduced in C99, and other flags can have other meanings that are described in the file. <code class="highlighter-rouge">for</code> is a statement present in all variations, so it has the flag <code class="highlighter-rouge">KEYALL</code>. In order for clang to recognize <code class="highlighter-rouge">four</code> as a statement, we need to add our own keyword. Firstly, copy the line where <code class="highlighter-rouge">for</code> is defined as a keyword, paste the line right below it, and change the “for” to “four”. It should look like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KEYWORD(float                       , KEYALL)
KEYWORD(for                         , KEYALL)
KEYWORD(four                        , KEYALL)
KEYWORD(goto                        , KEYALL)
</code></pre></div></div>

<p>Now we need to find the parser, where clang searches for the keywords in the source file. This logic can be found in <code class="highlighter-rouge">clang/lib/Parse/ParseStmt.cpp</code>. In this file, we find <code class="highlighter-rouge">Parser::ParseStatementOrDeclarationAfterAttributes</code>. This function includes MANY case statements for finding statements in the source file. At line 266, we find this line:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  case tok::kw_for:                 // C99 6.8.5.3: for-statement
    return ParseForStatement(TrailingElseLoc);
</code></pre></div></div>

<p>This case statement assigns what happens when a <code class="highlighter-rouge">for</code> statement is found. We want to copy this, and pass a function argument with it when the token <code class="highlighter-rouge">four</code> is found.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  case tok::kw_for:                 // C99 6.8.5.3: for-statement
    return ParseForStatement(TrailingElseLoc);
  case tok::kw_four:
    return ParseForStatement(TrailingElseLoc, true);
</code></pre></div></div>

<p>Further down in the file, we find the function called if the token is found, <code class="highlighter-rouge">Parser::ParseForStatement</code>. We need to modify it a bit. originally, the first few lines are written like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>StmtResult Parser::ParseForStatement(SourceLocation *TrailingElseLoc) {
    assert(Tok.is(tok::kw_for) &amp;&amp; "Not a for stmt!");
</code></pre></div></div>

<p>And we are going to modify it to look like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>StmtResult Parser::ParseForStatement(SourceLocation *TrailingElseLoc, bool is_four_statement) {
  if (is_four_statement) {
    assert(Tok.is(tok::kw_four) &amp;&amp; "Not a four stmt!");
  } else {
    assert(Tok.is(tok::kw_for) &amp;&amp; "Not a for stmt!");
  }
</code></pre></div></div>

<p>Now we have added a <code class="highlighter-rouge">is_four_statement</code> boolean function argument and added an assert to make sure it is a proper statement token. At line 2081, the function calls <code class="highlighter-rouge">Actions.ActOnForStmt</code>. We need to pass our <code class="highlighter-rouge">four</code> statement boolean to that. So we change change this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return Actions.ActOnForStmt(ForLoc, T.getOpenLocation(), FirstPart.get(),
                              SecondPart, ThirdPart, T.getCloseLocation(),
                              Body.get());
</code></pre></div></div>

<p>to this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return Actions.ActOnForStmt(ForLoc, T.getOpenLocation(), FirstPart.get(),
                              SecondPart, ThirdPart, T.getCloseLocation(),
                              Body.get(), is_four_statement);
</code></pre></div></div>

<p><code class="highlighter-rouge">ActOnForStmt</code> can be found in <code class="highlighter-rouge">clang/lib/Sema/SemaStmt.cpp</code>. On line 1778, we need to change the function arguments here.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>StmtResult Sema::ActOnForStmt(SourceLocation ForLoc, SourceLocation LParenLoc,
                              Stmt *First, ConditionResult Second,
                              FullExprArg third, SourceLocation RParenLoc,
                              Stmt *Body) {
</code></pre></div></div>

<p>We simply pass our “four” loop boolean arguments here too.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>StmtResult Sema::ActOnForStmt(SourceLocation ForLoc, SourceLocation LParenLoc,
                              Stmt *First, ConditionResult Second,
                              FullExprArg third, SourceLocation RParenLoc,
                              Stmt *Body, bool is_four_statement) {
</code></pre></div></div>

<p>Now, we need to see where this function goes. This function calls <code class="highlighter-rouge">ForStmt</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  return new (Context)
      ForStmt(Context, First, Second.get().second, Second.get().first, Third,
              Body, ForLoc, LParenLoc, RParenLoc);
</code></pre></div></div>

<p>Same drill here, add our extra function arg we keep passing down through the functions.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  return new (Context)
      ForStmt(Context, First, Second.get().second, Second.get().first, Third,
              Body, ForLoc, LParenLoc, RParenLoc, is_four_statement);
</code></pre></div></div>

<p><code class="highlighter-rouge">ForStmt</code> is defined in <code class="highlighter-rouge">clang/lib/AST/Stmt.cpp</code>. So again, we add our function argument to this function definition.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ForStmt::ForStmt(const ASTContext &amp;C, Stmt *Init, Expr *Cond, VarDecl *condVar,
                 Expr *Inc, Stmt *Body, SourceLocation FL, SourceLocation LP,
                 SourceLocation RP, bool is_four_statement)
</code></pre></div></div>

<p>If <code class="highlighter-rouge">ForStmt::ForStmt</code> sounds familiar, it’s used in the first code-gen file we modified, where the <code class="highlighter-rouge">for</code> loop counter is actually incremented. While we’re still editing <code class="highlighter-rouge">Stmt.c</code>, we need to add one more line. Around line 927, some variables for the function are assigned, we simply need to assign our function argument to a variable.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SubExprs[INC] = Inc;
SubExprs[BODY] = Body;
ForStmtBits.ForLoc = FL;
FourStatement = is_four_statement;
</code></pre></div></div>

<p>Now we head on over to the header file - <code class="highlighter-rouge">clang/include/clang/AST/Stmt.h</code>. We need to add our function argument in the public declaration on line 2460.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ForStmt(const ASTContext &amp;C, Stmt *Init, Expr *Cond, VarDecl *condVar,
          Expr *Inc, Stmt *Body, SourceLocation FL, SourceLocation LP,
          SourceLocation RP, bool is_four_statement=false);
</code></pre></div></div>

<p>Now we, we can access functions in this header from the code-gen file we modified earlier to test the increment. So we just need to add a function to return the value of <code class="highlighter-rouge">FourStatement</code>. Right below <code class="highlighter-rouge">getInit</code>, we’ll add this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bool isFourStatement() const { return FourStatement; }
bool FourStatement = false;
</code></pre></div></div>

<p>We set the variable to false afterwards so that way the <code class="highlighter-rouge">for</code> loops aren’t always in increments of four.</p>

<p>Now we are through with that file and need to go back to <code class="highlighter-rouge">clang/lib/CodeGen/CGStmt.cpp</code>. Now we can change the block of code that increments the for loop to check if <code class="highlighter-rouge">FourStatement</code> is true, and if so we increment three more times. In the function arguments of <code class="highlighter-rouge">EmitForStmt</code>, we see the address of <code class="highlighter-rouge">ForStmt</code> is assigned to <code class="highlighter-rouge">S</code>. We can check our <code class="highlighter-rouge">four</code> loop boolean by simply checking <code class="highlighter-rouge">S.isFourStatement()</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (S.getInc()) {
    EmitBlock(Continue.getBlock());
    EmitStmt(S.getInc());

    if (S.isFourStatement()) {
      EmitStmt(S.getInc());
      EmitStmt(S.getInc());
      EmitStmt(S.getInc());
    }
</code></pre></div></div>

<p>And we’re done! Now we need to go back to <code class="highlighter-rouge">llvm-project/build</code> and rebuild clang again with <code class="highlighter-rouge">make -j 8</code>. If no errors are found, we can now build a test program.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//four_test.c
int main() {
        printf("For Loop\n");
        for(int i = 0; i &lt; 13; i++) {
                printf("%d\n", i);
        }

        printf("Four Loop\n");
        four(int i = 0; i &lt; 13; i++) {
                printf("%d\n", i);
        }
}
</code></pre></div></div>

<p>This should test if our <code class="highlighter-rouge">for</code> and <code class="highlighter-rouge">four</code> loops work. Now we build the program with the new clang that’s in <code class="highlighter-rouge">llvm-project/build/bin</code> like so: <code class="highlighter-rouge">bin/clang four_test.c -o four_test</code>. Now run it and check the output!</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AJ@AJs-Macbook-Pro build % ./four_test 
For Loop
0
1
2
3
4
5
6
7
8
9
10
11
12
Four Loop
0
4
8
12
</code></pre></div></div>

<p>Success!!</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="https://starwarsfan2099.github.io/2020/08/03/python-code-golf/">
            Python Roman Numeral Code Golf
            <small>03 Aug 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="https://starwarsfan2099.github.io/2020/05/26/marchant-calculator/">
            Marchant "Silent Speed" Mechanical Calculator Repair and Operation.
            <small>26 May 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="https://starwarsfan2099.github.io/2020/01/25/dji-spark-log-decryption/">
            Decrypting DJI Spark Drone Log Files
            <small>25 Jan 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
